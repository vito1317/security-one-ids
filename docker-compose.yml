services:
  # Security One IDS/IPS Agent
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: security-one-ids
    restart: unless-stopped
    ports:
      - "8003:80"
    env_file:
      - .env
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - WAF_URL=${WAF_URL:-http://host.docker.internal:8001}
      - AGENT_TOKEN=${AGENT_TOKEN:-}
      - AGENT_NAME=${AGENT_NAME:-IDS-Agent-1}
    volumes:
      - ./database:/var/www/html/database
      - ./storage:/var/www/html/storage
      # Mount host log directories for monitoring (read-only)
      # Web server logs
      - /var/log/nginx:/var/log/host-nginx:ro
      - /var/log/apache2:/var/log/host-apache2:ro
      - /var/log/httpd:/var/log/host-httpd:ro
      # System logs (for desktop/personal computer monitoring)
      - /var/log/auth.log:/var/log/host-auth.log:ro
      - /var/log/syslog:/var/log/host-syslog:ro
      - /var/log/secure:/var/log/host-secure:ro
      - /var/log/messages:/var/log/host-messages:ro
      # UFW Firewall logs
      - /var/log/ufw.log:/var/log/host-ufw.log:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  default:
    name: security-one-ids-network
    driver: bridge
